<% content_for :title, "Pohledávky - Dlužírna" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Pohledávky</h1>
  <%= link_to "Nová pohledávka", new_admin_debt_path, class: "btn btn-primary" %>
</div>

<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: admin_debts_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.text_field :search, placeholder: "Hledat podle e-mailu...", value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-3">
        <%= f.select :status, options_for_select([
          ['Všechny stavy', ''],
          ['Čekající', 'pending'],
          ['Notifikováno', 'notified'],
          ['Zobrazeno', 'viewed'],
          ['Registrováno', 'registered'],
          ['Vyřešeno', 'resolved']
        ], params[:status]), {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= f.submit "Filtrovat", class: "btn btn-outline-primary" %>
      </div>
      <div class="col-md-3">
        <%= link_to "Vymazat filtry", admin_debts_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <% if @debts.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Zákazník</th>
              <th>Částka</th>
              <th>Splatnost</th>
              <th>Stav</th>
              <th>Vytvořeno</th>
              <th>Akce</th>
            </tr>
          </thead>
          <tbody>
            <% @debts.each do |debt| %>
              <tr class="<%= 'table-danger' if debt.overdue? %>">
                <td>
                  <%= debt.customer_email %>
                  <% if debt.customer_user.present? %>
                    <span class="badge bg-success ms-1">Registrován</span>
                  <% end %>
                </td>
                <td>
                  <strong><%= number_to_currency(debt.amount, unit: "Kč") %></strong>
                </td>
                <td>
                  <%= l(debt.due_date, format: :short) %>
                  <% if debt.due_date < Date.current %>
                    <span class="text-danger ms-1">
                      (po splatnosti <%= distance_of_time_in_words(debt.due_date, Date.current) %>)
                    </span>
                  <% end %>
                </td>
                <td>
                  <span class="badge bg-<%= 
                    case debt.status
                    when 'pending' then 'secondary'
                    when 'notified' then 'warning'
                    when 'viewed' then 'info'
                    when 'registered' then 'primary'
                    when 'resolved' then 'success'
                    end
                  %>">
                    <%= debt.status.humanize %>
                  </span>
                </td>
                <td><%= l(debt.created_at, format: :short) %></td>
                <td>
                  <div class="btn-group" role="group">
                    <%= link_to "Detail", admin_debt_path(debt), class: "btn btn-sm btn-outline-primary" %>
                    <%= link_to "Upravit", edit_admin_debt_path(debt), class: "btn btn-sm btn-outline-secondary" %>
                    <%= link_to "Smazat", admin_debt_path(debt), method: :delete, 
                        confirm: "Opravdu chcete smazat tuto pohledávku?", 
                        class: "btn btn-sm btn-outline-danger" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if respond_to?(:paginate) %>
        <div class="d-flex justify-content-center mt-4">
          <%= paginate @debts %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <h5 class="text-muted">Žádné pohledávky nenalezeny</h5>
        <p class="text-muted">Zkuste upravit filtry nebo <%= link_to "vytvořte novou pohledávku", new_admin_debt_path, class: "text-primary" %>.</p>
      </div>
    <% end %>
  </div>
</div>