<% content_for :title, "Detail pohledávky - Dlužírna Admin" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Detail pohledávky</h1>
  <div>
    <%= link_to "Upravit", edit_admin_debt_path(@debt), class: "btn btn-primary me-2" %>
    <%= link_to "← Zpět na seznam", admin_debts_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Informace o pohledávce</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-sm-4"><strong>E-mail zákazníka:</strong></div>
          <div class="col-sm-8">
            <%= @debt.customer_email %>
            <% if @debt.customer_user.present? %>
              <span class="badge bg-success ms-2">Registrován</span>
            <% else %>
              <span class="badge bg-warning ms-2">Neregistrován</span>
            <% end %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Částka:</strong></div>
          <div class="col-sm-8">
            <span class="h4 text-danger">
              <%= number_to_currency(@debt.amount, unit: "Kč", separator: ",", delimiter: " ") %>
            </span>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Datum splatnosti:</strong></div>
          <div class="col-sm-8">
            <span class="<%= 'text-danger' if @debt.due_date < Date.current %>">
              <%= l(@debt.due_date, format: :long) %>
            </span>
            <% if @debt.due_date < Date.current %>
              <br>
              <small class="text-danger">
                Po splatnosti <%= distance_of_time_in_words(@debt.due_date, Date.current) %>
              </small>
            <% end %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Stav:</strong></div>
          <div class="col-sm-8">
            <span class="badge bg-<%= 
              case @debt.status
              when 'pending' then 'secondary'
              when 'notified' then 'warning'
              when 'viewed' then 'info'
              when 'registered' then 'primary'
              when 'resolved' then 'success'
              end
            %> fs-6">
              <%= @debt.status.humanize %>
            </span>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4"><strong>Vytvořeno:</strong></div>
          <div class="col-sm-8"><%= l(@debt.created_at, format: :long) %></div>
        </div>

        <% if @debt.notified_at.present? %>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Notifikováno:</strong></div>
            <div class="col-sm-8"><%= l(@debt.notified_at, format: :long) %></div>
          </div>
        <% end %>

        <% if @debt.viewed_at.present? %>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Zobrazeno:</strong></div>
            <div class="col-sm-8"><%= l(@debt.viewed_at, format: :long) %></div>
          </div>
        <% end %>

        <hr>

        <h6><strong>Popis pohledávky:</strong></h6>
        <div class="bg-light p-3 rounded">
          <%= @debt.description %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">Rychlé akce</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <%= link_to "Upravit pohledávku", edit_admin_debt_path(@debt), class: "btn btn-outline-primary" %>
          
          <button type="button" class="btn btn-outline-info" onclick="togglePublicLink()">
            Zobrazit veřejný odkaz
          </button>
          
          <div id="publicLinkSection" style="display: none;" class="mt-3">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Veřejný odkaz na pohledávku</h6>
              </div>
              <div class="card-body">
                <p class="small">Tento odkaz můžete poslat zákazníkovi pro zobrazení pohledávky:</p>
                <div class="input-group">
                  <input type="text" class="form-control" value="<%= pohledavky_url(@debt.token) %>" readonly id="publicLinkInput">
                  <button class="btn btn-outline-secondary" type="button" onclick="copyPublicLink()">
                    Kopírovat
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <% unless @debt.resolved? %>
            <%= form_with model: [@debt], url: admin_debt_path(@debt), method: :patch, local: true, class: "d-grid" do |f| %>
              <%= f.hidden_field :status, value: :resolved %>
              <%= f.submit "Označit jako vyřešeno", 
                  class: "btn btn-outline-success",
                  onclick: "return confirm('Označit tuto pohledávku jako vyřešenou?')" %>
            <% end %>
          <% end %>
          
          <%= form_with model: [@debt], url: admin_debt_path(@debt), method: :delete, local: true, class: "d-grid" do |f| %>
            <%= f.submit "Smazat pohledávku", 
                class: "btn btn-outline-danger",
                onclick: "return confirm('Opravdu chcete smazat tuto pohledávku?')" %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <h6 class="card-title mb-0">Statistiky</h6>
      </div>
      <div class="card-body">
        <small class="text-muted">Token ID:</small><br>
        <code class="text-break"><%= @debt.token %></code>
      </div>
    </div>
  </div>
</div>

<script>
function togglePublicLink() {
  const section = document.getElementById('publicLinkSection');
  const button = event.target;
  
  if (section.style.display === 'none') {
    section.style.display = 'block';
    button.textContent = 'Skrýt veřejný odkaz';
    button.classList.remove('btn-outline-info');
    button.classList.add('btn-info');
  } else {
    section.style.display = 'none';
    button.textContent = 'Zobrazit veřejný odkaz';
    button.classList.remove('btn-info');
    button.classList.add('btn-outline-info');
  }
}

async function copyPublicLink() {
  const input = document.getElementById('publicLinkInput');
  const button = event.target;
  
  try {
    input.select();
    await navigator.clipboard.writeText(input.value);
  } catch (err) {
    // Fallback for older browsers
    input.select();
    document.execCommand('copy');
  }
  
  const originalText = button.textContent;
  button.textContent = 'Zkopírováno!';
  button.classList.remove('btn-outline-secondary');
  button.classList.add('btn-success');
  
  setTimeout(() => {
    button.textContent = originalText;
    button.classList.remove('btn-success');
    button.classList.add('btn-outline-secondary');
  }, 2000);
}
</script>